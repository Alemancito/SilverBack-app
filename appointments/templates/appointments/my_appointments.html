<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar Mis Citas | Silver Back</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/css/intlTelInput.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { background-color: #f4f7f6; font-family: 'Poppins', sans-serif; min-height: 100vh; display: flex; flex-direction: column;}
        .header-bg { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); height: 140px; border-radius: 0 0 40px 40px; margin-bottom: -80px; }
        .main-card { border: none; border-radius: 25px; box-shadow: 0 20px 40px rgba(0,0,0,0.08); background: white; padding: 40px 30px; margin-bottom: 30px; }
        .appointment-card { border: none; border-left: 5px solid #28a745; border-radius: 18px; background: white; box-shadow: 0 10px 25px rgba(0,0,0,0.03); margin-bottom: 25px; padding: 25px; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); position: relative; overflow: hidden; }
        .appointment-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.08); }
        .client-name { font-weight: 700; color: #2c3e50; font-size: 1.2rem; margin-bottom: 5px; }
        .nickname-badge { background-color: #e3f2fd; color: #1565c0; font-size: 0.8rem; font-weight: 500; padding: 4px 12px; border-radius: 20px; display: inline-flex; align-items: center; gap: 5px; }
        .time-display { font-size: 1.3rem; font-weight: 700; color: #28a745; margin-top: 15px; display: flex; align-items: center; gap: 8px; }
        .date-box { text-align: center; background: #f8f9fa; border-radius: 15px; padding: 12px 15px; min-width: 90px; border: 1px solid #edf2f7; }
        .date-day-num { font-size: 1.8rem; font-weight: 700; line-height: 1; color: #1e3c72; }
        .date-day-name { font-size: 0.75rem; text-transform: uppercase; color: #95a5a6; font-weight: 600; letter-spacing: 1px;}
        .btn-soft-warning { background-color: #fff8e1; color: #f39c12; border: none; font-weight: 600; padding: 10px; border-radius: 12px; transition: 0.2s; }
        .btn-soft-warning:hover { background-color: #f39c12; color: white; }
        .btn-soft-danger { background-color: #ffebee; color: #ef5350; border: none; font-weight: 600; padding: 10px; border-radius: 12px; transition: 0.2s; }
        .btn-soft-danger:hover { background-color: #ef5350; color: white; }
        .iti { width: 100%; }
        .form-control-lg { font-size: 1.1rem; padding: 15px; border-radius: 15px; background-color: #f8f9fa; }
        .form-control-lg:focus { background-color: white; box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.15); border-color: #a6cbf3;}
        .btn-time-option { border: 1px solid #e9ecef; border-radius: 12px; padding: 12px; text-align: center; width: 100%; margin-bottom: 10px; color: #555; font-weight: 500; background: white; transition: 0.2s; }
        .btn-time-option:hover { background-color: #e3f2fd; border-color: #e3f2fd; color: #0d6efd; transform: scale(1.02); }
    </style>

    <link rel="icon" type="image/png" href="{% static 'img/favicon.png' %}">
</head>
<body>

<div class="header-bg"></div>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-7 col-lg-5">
            
            <div class="main-card mt-5">
                <h3 class="fw-bold text-center mb-2" style="color: #1e3c72;">Tus Citas</h3>
                <p class="text-muted text-center small mb-4">Ingresa tu número y PIN para ver tus reservas.</p>

                <form method="POST" id="searchForm" autocomplete="off">
                    {% csrf_token %}
                    
                    <input type="text" style="display:none" name="fake_username_prevention">
                    <input type="password" style="display:none" name="fake_password_prevention">

                    <div class="mb-3">
                        <input type="tel" id="phone_field" class="form-control form-control-lg border-0" placeholder="Teléfono">
                        <input type="hidden" name="full_phone" id="full_phone">
                        <div class="form-text mt-2 fw-bold text-center" id="phone_error" style="color: #dc3545; display: none;"></div>
                    </div>

                    <div class="mb-4">
                        <input type="password" id="pin_field" name="pin" class="form-control form-control-lg border-0 text-center fw-bold" 
                               placeholder="Tu PIN (4 dígitos)" maxlength="4" inputmode="numeric" required
                               style="letter-spacing: 5px;" autocomplete="new-password">
                    </div>

                    <button type="submit" class="btn btn-primary w-100 rounded-pill py-3 fw-bold shadow-sm" style="background: #1e3c72; border:none;">
                        <i class="bi bi-search me-2"></i> Buscar Citas
                    </button>
                </form>
                
                <div class="text-center mt-4">
                    <a href="{% url 'booking_calendar' %}" class="text-decoration-none text-muted fw-500" style="font-size: 0.9rem;">
                        <i class="bi bi-arrow-left"></i> Volver al Calendario
                    </a>
                </div>
            </div>

            {% if messages %}
                {% for message in messages %}
                <script>
                    // FILTRO DE MENSAJE: Si el texto contiene "agendada", NO lo mostramos aquí
                    var messageText = "{{ message }}";
                    
                    if (!messageText.toLowerCase().includes("agendada")) {
                        var iconType = "{{ message.tags }}".includes('error') ? 'error' : 'success';
                        Swal.fire({
                            icon: iconType,
                            title: iconType === 'error' ? 'Error' : '¡Listo!',
                            text: messageText,
                            confirmButtonColor: '#1e3c72',
                            timer: 3000
                        });
                    }
                </script>
                {% endfor %}
            {% endif %}

            <div class="pb-5">
                {% if search_performed %}
                    {% if appointments %}
                        <div class="d-flex align-items-center mb-3 ms-1">
                            <i class="bi bi-calendar-check text-primary me-2"></i>
                            <span class="text-muted small fw-bold text-uppercase">Reservas Activas</span>
                        </div>
                        
                        {% for app in appointments %}
                        <div class="appointment-card">
                            <div class="d-flex justify-content-between align-items-start">
                                
                                <div>
                                    <div class="client-name">
                                        {{ app.client.first_name }} {{ app.client.last_name }}
                                    </div>
                                    {% if app.client.nickname %}
                                        <div class="nickname-badge">
                                            <i class="bi bi-tag-fill" style="font-size: 0.7rem;"></i> {{ app.client.nickname }}
                                        </div>
                                    {% endif %}
                                    
                                    <div class="time-display">
                                        <i class="bi bi-clock"></i> {{ app.time|time:"h:i A" }}
                                    </div>
                                </div>

                                <div class="date-box">
                                    <div class="date-day-name">{{ app.date|date:"l" }}</div>
                                    <div class="date-day-num">{{ app.date|date:"d" }}</div>
                                    <div class="date-day-name">{{ app.date|date:"M"|upper }}</div>
                                </div>
                            </div>

                            <hr class="my-4" style="border-top: 2px dashed #f0f0f0; opacity: 1;">

                            <div class="row g-3">
                                <div class="col-6">
                                    <button class="btn-soft-warning w-100" 
                                            onclick="openPostponeModal('{{ app.id }}', '{{ app.date|date:'Y-m-d' }}')">
                                        <i class="bi bi-arrow-repeat me-1"></i> Posponer
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn-soft-danger w-100" 
                                            onclick="confirmCancel('{{ app.id }}')">
                                        <i class="bi bi-x-lg me-1"></i> Cancelar
                                    </button>
                                </div>
                            </div>
                            
                            <form id="cancel-form-{{ app.id }}" action="{% url 'cancel_appointment' app.id %}" method="POST" style="display: none;">
                                {% csrf_token %}
                            </form>
                        </div>
                        {% endfor %}
                    
                    {% else %}
                        <div class="text-center py-5 opacity-50">
                            <i class="bi bi-journal-x" style="font-size: 4rem; color: #bdc3c7;"></i>
                            <p class="mt-3 text-muted fw-500">No encontramos citas con esos datos.</p>
                            <a href="{% url 'booking_calendar' %}" class="btn btn-outline-primary rounded-pill mt-2 px-4">Agendar Nueva</a>
                        </div>
                    {% endif %}
                {% endif %}
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="postponeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fs-5 fw-bold text-dark ps-2">Cambiar hora (Mismo día)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <p class="small text-muted mb-3 ps-2">Selecciona un nuevo espacio disponible:</p>
        <div id="postponeLoading" class="text-center py-3"><div class="spinner-border text-primary spinner-border-sm"></div></div>
        <div id="postponeOptions" class="row g-2"></div>
      </div>
    </div>
  </div>
</div>

<form id="postponeForm" method="POST" style="display:none;">
    {% csrf_token %}
    <input type="hidden" name="new_time" id="new_time_input">
</form>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/intlTelInput.min.js"></script>

<script>
    const input = document.querySelector("#phone_field");
    const pinInput = document.querySelector("#pin_field"); // Seleccionamos el campo PIN
    const errorMsg = document.querySelector("#phone_error");
    const iti = window.intlTelInput(input, {
        utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js", 
        initialCountry: "sv",
        separateDialCode: true, 
        preferredCountries: ["sv", "gt", "hn", "ni", "us"],
    });

    // LIMPIEZA AGRESIVA DEL PIN AL CARGAR LA PÁGINA
    window.addEventListener('load', function() {
        if(pinInput) {
            pinInput.value = '';
            pinInput.setAttribute('autocomplete', 'new-password');
        }
    });

    input.addEventListener("keydown", function(e) {
        const allowedKeys = [46, 8, 9, 27, 13, 110];
        if (allowedKeys.indexOf(e.keyCode) !== -1 || (e.keyCode >= 35 && e.keyCode <= 40)) return;
        if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) e.preventDefault(); 
    });

    document.getElementById('searchForm').addEventListener('submit', function(e) {
        if (iti.isValidNumber()) {
            document.getElementById('full_phone').value = iti.getNumber();
        } else {
            e.preventDefault();
            errorMsg.style.display = 'block';
            errorMsg.innerText = "Número inválido. Revisa el formato.";
        }
    });

    function confirmCancel(appId) {
        Swal.fire({
            title: '¿Cancelar cita?',
            text: "No podrás deshacer esta acción.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef5350',
            cancelButtonColor: '#adb5bd',
            confirmButtonText: 'Sí, cancelar',
            cancelButtonText: 'Volver',
            customClass: { popup: 'rounded-4' }
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('cancel-form-' + appId).submit();
            }
        })
    }

    let currentPostponeAppId = null;
    function openPostponeModal(appId, dateStr) {
        currentPostponeAppId = appId;
        const modal = new bootstrap.Modal(document.getElementById('postponeModal'));
        modal.show();
        
        const container = document.getElementById('postponeOptions');
        const loader = document.getElementById('postponeLoading');
        
        container.innerHTML = '';
        loader.style.display = 'block';

        fetch(`/get-hours/?date=${dateStr}`)
            .then(res => res.json())
            .then(data => {
                loader.style.display = 'none';
                const allSlots = [...data.morning, ...data.noon, ...data.afternoon, ...data.evening];
                
                if(allSlots.length === 0) {
                    container.innerHTML = '<div class="col-12 text-center"><p class="text-danger small bg-danger bg-opacity-10 p-2 rounded">Lo sentimos, no hay más cupos hoy.</p></div>';
                    return;
                }

                allSlots.forEach(time => {
                    const col = document.createElement('div');
                    col.className = 'col-4';
                    col.innerHTML = `<button type="button" class="btn-time-option" onclick="submitPostpone('${time}')">${time}</button>`;
                    container.appendChild(col);
                });
            });
    }

    function submitPostpone(newTime) {
        const form = document.getElementById('postponeForm');
        form.action = `/postpone/${currentPostponeAppId}/`;
        document.getElementById('new_time_input').value = newTime;
        
        Swal.fire({
            title: 'Actualizando...',
            text: 'Moviendo tu cita',
            timer: 1000,
            timerProgressBar: true,
            didOpen: () => { Swal.showLoading(); }
        }).then(() => {
            form.submit();
        });
    }
</script>

</body>
</html>