{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmar Cita | Silver Back</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/css/intlTelInput.css">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Poppins', sans-serif; }
        .card-ticket { border: none; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        .ticket-header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 30px; text-align: center; }
        .ticket-body { padding: 40px; background: white; }
        .iti { width: 100%; }
        @media (max-width: 768px) { .ticket-header { padding: 25px 15px; } .ticket-body { padding: 30px 20px; } input, select, textarea { font-size: 16px !important; } }
    </style>
    <link rel="icon" type="image/png" href="{% static 'img/favicon.png' %}">
</head>
<body>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8 col-xl-6">
            <div class="card card-ticket">
                <div class="ticket-header">
                    <h3 class="mb-0">Completa tus datos</h3>
                    <p class="mb-0 opacity-75 mt-2" style="font-size: 1.1rem;">
                        Reserva para <span class="fw-bold text-warning">{{ date_obj|date:"l d"|title }}</span> a las <span class="fw-bold">{{ time }}</span>
                    </p>
                </div>
                
                <div class="ticket-body">
                    <form method="POST" id="bookingForm" novalidate autocomplete="off">
                        {% csrf_token %}
                        <input type="text" style="display:none" name="fake_user_prevention">
                        <input type="password" style="display:none" name="fake_pass_prevention">

                        <div class="mb-4">
                            <label class="form-label fw-bold"><i class="bi bi-phone"></i> Tu Teléfono</label>
                            {{ form.phone_number }}
                            <input type="hidden" name="full_phone" id="full_phone">
                            <div class="form-text mt-2" id="phone_error" style="color: red; display: none;"></div>
                            <div class="form-text text-muted" style="font-size: 0.85rem;">
                                <i class="bi bi-info-circle"></i> Elige tu bandera e ingresa tu numero de teléfono.
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="p-3 bg-light rounded border border-secondary border-opacity-10">
                                <label class="form-label fw-bold mb-1">Crea tu PIN de Seguridad</label>
                                <div class="small text-muted mb-2" style="font-size: 0.85rem;">
                                    <i class="bi bi-shield-lock"></i> Lo usarás para ver y cancelar tus citas.
                                </div>
                                {{ form.pin }}
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label fw-bold">Nombre</label>
                                {{ form.first_name }}
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-bold">Apellido</label>
                                {{ form.last_name }}
                            </div>
                        </div>

                        <div class="mb-4 p-3 bg-light rounded border border-secondary border-opacity-10">
                            <label class="form-label fw-bold text-primary">
                                <i class="bi bi-stars"></i> ¿Tienes un Apodo? (Opcional)
                            </label>
                            {{ form.nickname }}
                            <div class="form-text small mt-2">
                                "¿Cómo te llaman tus amigos?, tu nombre completo solo lo usa tu mamá cuando esta enojada"
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" id="submitBtn" class="btn btn-primary btn-lg py-3 rounded-pill shadow-sm">
                                Confirmar Reserva <i class="bi bi-check-circle-fill ms-2"></i>
                            </button>
                            <a href="{% url 'booking_calendar' %}" class="btn btn-outline-secondary btn-sm border-0">Cambiar fecha/hora</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/intlTelInput.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const input = document.querySelector("#phone_field");
    const firstNameInput = document.querySelector("#id_first_name");
    const lastNameInput = document.querySelector("#id_last_name");
    const pinInput = document.querySelector("#id_pin");
    const submitBtn = document.querySelector("#submitBtn");

    if(pinInput) {
        pinInput.value = '';
        pinInput.setAttribute('readonly', true);
        pinInput.setAttribute('autocomplete', 'new-password');
        pinInput.addEventListener('focus', function() { this.removeAttribute('readonly'); });
    }

    const iti = window.intlTelInput(input, {
        utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js", 
        initialCountry: "sv",
        separateDialCode: true, 
        preferredCountries: ["sv", "gt", "hn", "ni", "us"],
        autoPlaceholder: "aggressive", 
    });

    const form = document.getElementById('bookingForm');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        // Validaciones básicas
        if (!firstNameInput.value.trim() || !lastNameInput.value.trim() || !pinInput.value.trim() || !input.value.trim() || !iti.isValidNumber()) {
            Swal.fire({ icon: 'warning', title: 'Datos incompletos', text: 'Por favor, revisa que todos los campos sean correctos.', confirmButtonColor: '#0d6efd' });
            return;
        }

        // BLOQUEO DE DOBLE CLIC
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'Agendando... <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

        const fullNumber = iti.getNumber();
        document.getElementById('full_phone').value = fullNumber;

        // Mostrar cargando mientras Railway procesa
        Swal.fire({
            title: 'Confirmando espacio...',
            text: 'Verificando disponibilidad en tiempo real.',
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => { Swal.showLoading(); }
        });

        this.submit();
    });
</script>
</body>
</html>